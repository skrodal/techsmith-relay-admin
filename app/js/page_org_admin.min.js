var PAGE_ORG_ADMIN=function(){function e(){l(),i(),d=DATAPORTEN.user().org.id,c=DATAPORTEN.user().org.shortname}function t(){$.when(RELAY.ready().done(function(){b=o()})),a()}function n(){r()}function a(){$("#pageOrgAdmin").find("#inputCostTB").val(RELAY.storageCostTB()),$("#pageOrgAdmin").find(".costTB").text("kr. "+RELAY.storageCostTB()),$.when(RELAY_ORG.users()).done(function(e){$("#pageOrgAdmin").find(".orgUserCount").text(e.length)}),$.when(RELAY_ORG.diskUsage()).done(function(e){$("#pageOrgAdmin").find(".orgDiskUsage").text(UTILS.mib2gb(e.total_mib).toFixed(2)+"GB"),$("#pageOrgAdmin").find(".orgDiskUsageDate").text(UTILS.timestamp2date(e.storage[e.storage.length-1].date.sec)),$("#pageOrgAdmin").find(".orgStorageCostEstimate").text("kr. "+(UTILS.mib2tb(e.total_mib)*RELAY.storageCostTB()).toFixed())}),$.when(DATAPORTEN.orgAdminInvitationLinkXHR()).done(function(e){$("#pageOrgAdmin").find(".orgAdminGroupLink").text(e)}),$.when(RELAY_ORG.presentationCount()).done(function(e){$("#pageOrgAdmin").find(".orgPresentationCount").text(e)}),$("#pageOrgAdmin").find(".orgRecordedDatesNum").text(u)}function s(){var e=$("#pageOrgAdmin").find("#inputCostTB").val();RELAY.setStorageCost(e)&&a()}function i(){p={};var e=0,t=0,n=0,a=0,s=0,i=0,o=0,r=0;$.when(RELAY_ORG.users(),RELAY_ORG.presentations()).done(function(l,d){var c;t=l.length,$.each(l,function(e,t){switch(t.affiliation.toLowerCase()){case"ansatt":o++,c="ansatt";break;case"student":r++,c="student";break;default:c="---"}p[t.username]={displayName:t.displayname,email:t.email,org:t.org,affiliation:c,status:t.status,userName:t.username,userNameOnDisk:t.usernameOnDisk,hits:0,diskusageMiB:0,presentationDurationTotalSec:0,presentationCount:0,presentationDeletedCount:0}}),$.each(d,function(t,i){p[i.username]&&(1!==i.is_deleted?(p[i.username].presentationCount++,e++,p[i.username].presentationDurationTotalSec+=i.duration_s,p[i.username].diskusageMiB+=i.size_mib,a+=i.duration_s,s+=i.size_mib):(p[i.username].presentationDeletedCount++,n++))});var u=$("#pageOrgAdmin").find("#usersTableOrg");$.fn.DataTable.isDataTable(u)&&(u=u.DataTable(),u.destroy());var b=($("#pageOrgAdmin").find("#usersTableOrg").DataTable({language:CONFIG.DATATABLES_LANGUAGE(),bAutoWidth:!0,sDom:'T<"clear">lfrtip',oTableTools:{sSwfPath:"dist/plugins/datatables/tabletools/swf/copy_csv_xls_pdf.swf",aButtons:[{sExtends:"copy",sButtonText:"Kopier"},{sExtends:"collection",sButtonText:"Lagre",aButtons:[{sExtends:"pdf",sPdfOrientation:"landscape",sTitle:"Relay_Abonnenter"},{sExtends:"xls",sButtonText:"Excel (.csv)",sTitle:"Relay_Abonnenter"}]}]},data:UTILS.convertDataTablesData(p),columns:[{data:"displayName",render:function(e,t,n,a){return'<a style="cursor:context-menu;" class="userTableMoreInfo" data-toggle="modal" data-target="#userDetailsModal" data-fullname="'+n.displayName+'" data-username="'+n.userName+'" data-email="'+n.email+'" data-presentationcount="'+n.presentationCount+'" data-presentationdeletedcount="'+n.presentationDeletedCount+'" data-hits="'+n.hits+'">'+e+"</a>"}},{data:"affiliation"},{data:"presentationCount"},{data:"presentationDeletedCount"},{data:"presentationDurationTotalSec",render:function(e,t,n,a){return UTILS.secToTime(e)}},{data:"diskusageMiB",render:function(e,t,n,a){return e.toFixed(2)}},{data:"hits",render:function(e,t,n,a){var s=parseInt(e)<100?"red":parseInt(e)<500?"yellow":"light-blue";return'<div style="width: 100%;" class="text-center"><span class="badge bg-'+s+'">'+e+"</span></div>"}}]}),$("#usersTableOrg"));b.find(".th-name").html("<span class='label label-default'><i class='ion ion-android-person'></i> = "+t+"</span>"),b.find(".th-type").html("<span class='label label-default'>A="+o+"/S="+r+"</span>"),b.find(".th-presentations").html("<span class='label label-default'><i class='ion ion-ios-film'></i> = "+e+"</span>"),b.find(".th-deleted").html("<span class='label label-default'><i class='ion ion-android-delete'></i> = "+n+"</span>"),b.find(".th-duration").html("<span class='label label-default'><i class='ion ion-ios-clock'></i> = "+UTILS.secToTimeAndDays(a)+"</span>"),b.find(".th-diskusage").html("<span class='label label-default'><i class='ion ion-android-upload'></i> = "+UTILS.mib2gb(s).toFixed(2)+"GB</span>"),b.find(".th-hits").html("<span class='label label-default'><i class='ion ion-stats-bars'></i> = "+i+"</span>"),$("#pageOrgAdmin").find("#usersTableBox").find(".ajax").hide()})}function o(){if(r(),u="INGEN",$("#lineChartOrgAlert").hide(),RELAY.orgStorageArr(d).length<2)return $("#lineChartOrgAlert").html("<code>"+c+"</code>&nbsp;&nbsp;har for f&aring; nylige lagringspunkter registrert til &aring; bygge grafen."),$("#lineChartOrgAlert").show(),!1;var e;e=JSON.parse(JSON.stringify(RELAY.orgStorageArr(d))),fillColor="undefined"!=typeof fillColor?fillColor:"#"+(Math.random().toString(16)+"0000000").slice(2,8);var t=30,n=t,a=[],s=[];e.reverse(),$.each(e,function(e,t){var i=new Date(1e3*t.date.sec);if(a.push(i.getUTCDate()+"."+(i.getUTCMonth()+1)+"."+i.getUTCFullYear()),s.push(UTILS.mib2gb(t.size_mib).toFixed(2)),n--,0==n)return!1}),u=t-n,s.reverse(),a.reverse();var i={labels:a,datasets:[{label:"Diskforbruk siste "+s.length+" dager",fillColor:fillColor,strokeColor:"#666",pointColor:"#fff",pointStrokeColor:"#666",pointHighlightFill:"#285C85",pointHighlightStroke:"rgba(60,141,188,1)",data:s}]},o=document.getElementById("orgUsageLineChartOrgAdmin").getContext("2d");return new Chart(o).Line(i,{showScale:!0,scaleShowGridLines:!1,scaleShowHorizontalLines:!0,scaleShowVerticalLines:!0,bezierCurve:!0,bezierCurveTension:.3,pointDot:!0,pointDotRadius:4,pointDotStrokeWidth:1,pointHitDetectionRadius:5,datasetStroke:!0,datasetStrokeWidth:2,datasetFill:!0,maintainAspectRatio:!1})}function r(){b!==!1&&(b.destroy(),b=!1)}function l(){var e="&nbsp;&nbsp;&nbsp;",t=""!==KIND.subscriberDetails().contact_person.navn?KIND.subscriberDetails().contact_person.navn:'<span class="label label-warning icon ion-android-warning"> Mangler</span>',n=""!==KIND.subscriberDetails().contact_person.e_post?KIND.subscriberDetails().contact_person.e_post:'<span class="label label-warning icon ion-android-warning"> Mangler</span>',a=""!==KIND.subscriberDetails().contact_person.direkte_telefon?KIND.subscriberDetails().contact_person.direkte_telefon:'<span class="label label-warning icon ion-android-warning"> Mangler</span>',s=""!==KIND.subscriberDetails().contact_person.mobil_telefon?KIND.subscriberDetails().contact_person.mobil_telefon:'<span class="label label-warning icon ion-android-warning"> Mangler</span>',i=""!==KIND.subscriberDetails().contact_support.navn?KIND.subscriberDetails().contact_support.navn:'<span class="label label-warning icon ion-android-warning"> Mangler</span>',o=""!==KIND.subscriberDetails().contact_support.e_post?KIND.subscriberDetails().contact_support.e_post:'<span class="label label-warning icon ion-android-warning"> Mangler</span>',r=""!==KIND.subscriberDetails().contact_support.direkte_telefon?KIND.subscriberDetails().contact_support.direkte_telefon:'<span class="label label-warning icon ion-android-warning"> Mangler</span>',l=""!==KIND.subscriberDetails().contact_support.mobil_telefon?KIND.subscriberDetails().contact_support.mobil_telefon:'<span class="label label-warning icon ion-android-warning"> Mangler</span>';$(".serviceContact").html("<p>"+e+'<i class="icon ion-android-person text-muted"></i>&nbsp;&nbsp;'+t+"<br>"+e+'<i class="icon ion-ios-email text-muted"></i>&nbsp;&nbsp;'+n+"<br>"+e+'<i class="icon ion-ios-telephone text-muted"></i>&nbsp;&nbsp;'+a+"<br>"+e+'<i class="icon ion-android-phone-portrait text-muted"></i>&nbsp;&nbsp;'+s+"</p>"),$(".serviceSupport").html("<p>"+e+'<i class="icon ion-help-buoy text-muted"></i>&nbsp;&nbsp;'+i+"<br>"+e+'<i class="icon ion-ios-email text-muted"></i>&nbsp;&nbsp;'+o+"<br>"+e+'<i class="icon ion-ios-telephone text-muted"></i>&nbsp;&nbsp;'+r+"<br>"+e+'<i class="icon ion-android-phone-portrait text-muted"></i>&nbsp;&nbsp;'+l+"</p>"),$(".serviceUrl").html("<p>"+e+'<i class="icon ion-link text-muted"> </i> '+KIND.subscriberDetails().service_uri+"</p>"),$(".subscriptionStatus").html('<span class="label bg-'+KIND.subscriptionCodesToColors()[KIND.subscriberDetails().subscription_cide]+'">'+KIND.subscriptionCodesToNames()[KIND.subscriberDetails().subscription_code]+"</span>")}var d,c,p={},u=0,b=!1;return $("#pageOrgAdmin #btnInvoiceCalc").on("click",s),$("#userDetailsModal").on("show.bs.modal",function(e){var t=$(e.relatedTarget),n=t.data("username"),a=t.data("presentationcount"),s=t.data("presentationdeletedcount"),i=(t.data("hits"),$(this));i.find("#fullName").text(t.data("fullname")),i.find("#userInfo").html("<p>Brukernavn: <code>"+n+"</code></p><p>Epost: <code>"+t.data("email")+"</code> </p>"),i.find("#jsonUserPresentations").empty(),i.find("#footerText").empty();var o=new JSONEditor(document.getElementById("jsonUserPresentations"),{modes:["view","text"],mode:"text",search:!0,indentation:4});$.when(RELAY_ORG.userContent(n,!1)).done(function(e){o.set(e),o.setName(n),0==s?i.find("#footerText").html('Presentasjoner: <span class="badge bg-green">'+a+"</span>"):i.find("#footerText").html('Presentasjoner: <span class="badge bg-green">'+(a+s)+'</span> ( av disse er <span class="badge bg-red">'+s+"</span> slettet )")}).fail(function(){i.find("#jsonUserPresentations").html('<div class="alert alert-warning" role="alert">Bruker <code>'+n+"</code> har ingen presentasjoner.</div>")})}),$("#emailExportOrgAdminModal").on("show.bs.modal",function(e){var t=[];$.each(p,function(e,n){t.push(n.displayName+" <"+n.email+">")}),$("#emailExportOrgAdminModal").find("#emailExportList").html(t.toString())}),$("#dataExportModal").on("show.bs.modal",function(e){if("orgAdmin"===$(e.relatedTarget).data().context){var t=$(this),n=$(e.relatedTarget).data().action;APP.jsonEditor().setName(n),APP.jsonEditor().set("Henter data, vennligst vent..."),$.when(RELAY_ORG.users(),RELAY_ORG.presentations()).done(function(e,a){switch(n){case"Brukere":t.find(".modal-title").html('<i class="ion ion-ios-people"></i> Eksporter metadata for alle <strong>brukere</strong>'),t.find("#legend_users").fadeIn(),APP.jsonEditor().set(p);break;case"Opptak":t.find(".modal-title").html('<i class="ion ion-ios-film"></i> Eksporter metadata for alle <strong>opptak</strong>'),t.find("#legend_users").hide(),APP.jsonEditor().set(a)}})}}),$("#dataExportModal").on("hide.bs.modal",function(e){APP.jsonEditor().set("Henter data, vennligst vent...")}),$("#orgUsageLineChartOrgAdmin").on("click",function(e){b.datasets[0].fillColor="#"+(Math.random().toString(16)+"0000000").slice(2,8),b.update()}),{init:function(){return e()},hide:function(){n()},show:function(){t()}}}();