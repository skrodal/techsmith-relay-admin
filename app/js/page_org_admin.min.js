var PAGE_ORG_ADMIN=function(){function e(){l=DATAPORTEN.user().org.id,d=DATAPORTEN.user().org.shortname,s()}function t(){f=i(),n()}function a(){o()}function n(){$("#pageOrgAdmin").find("#inputCostTB").val(RELAY.storageCostTB()),$("#pageOrgAdmin").find(".costTB").text("kr. "+RELAY.storageCostTB()),$("#pageOrgAdmin").find(".orgPresentationCount").text(RELAY.orgPresentationCount(l)),$("#pageOrgAdmin").find(".orgDiskUsage").text(UTILS.mib2gb(RELAY.orgStorageTotalMiB(l)).toFixed(2)+"GB"),$("#pageOrgAdmin").find(".orgDiskUsageDate").text(UTILS.timestamp2date(RELAY.orgStorageArr(l)[RELAY.orgStorageArr(l).length-1].date.sec)),$("#pageOrgAdmin").find(".orgStorageCostEstimate").text("kr. "+(UTILS.mib2tb(RELAY.orgStorageTotalMiB(l))*RELAY.storageCostTB()).toFixed()),$.when(DATAPORTEN.orgAdminInvitationLinkXHR()).done(function(e){$("#pageOrgAdmin").find(".orgAdminGroupLink").text(e)})}function r(){var e=$("#pageOrgAdmin").find("#inputCostTB").val();RELAY.setStorageCost(e)&&n()}function s(){u={};var e=0,t=0,a=0,n=0,r=0,s=0;$.when(RELAY_ORG.usersXHR(),RELAY_ORG.usersPresentationsXHR(),RELAY_ORG.usersHitsXHR()).done(function(i,o,l){t=i.length,n=l.total_hits,$.each(i,function(e,t){switch(t.userAffiliation.toLowerCase()){case"employee":r++,t.userAffiliation="ansatt";break;case"student":s++,t.userAffiliation="student";break;default:t.userAffiliation="---"}var a=t.userName.replace("@",""),n=l.users[a]?l.users[a]:0;u[t.userId]={userDisplayName:t.userDisplayName,userEmail:t.userEmail,userId:t.userId,userOrg:t.userOrg,userAffiliation:t.userAffiliation,userName:t.userName,userNameOnDisk:a,userHits:n,userPresentationDurationTotalSec:0,userPresentationCount:0}}),$.each(o,function(t,n){u[n.presUser_userId]&&(u[n.presUser_userId].userPresentationCount++,e++,u[n.presUser_userId].userPresentationDurationTotalSec+=parseInt(n.presDuration)/1e3,a+=parseInt(n.presDuration)/1e3)});var d=$("#pageOrgAdmin").find("#usersTableOrg");$.fn.DataTable.isDataTable(d)&&(d=d.DataTable(),d.destroy());var g=($("#pageOrgAdmin").find("#usersTableOrg").DataTable({language:CONFIG.DATATABLES_LANGUAGE(),bAutoWidth:!0,sDom:'T<"clear">lfrtip',oTableTools:{sSwfPath:"dist/plugins/datatables/tabletools/swf/copy_csv_xls_pdf.swf",aButtons:[{sExtends:"copy",sButtonText:"Kopier"},{sExtends:"collection",sButtonText:"Lagre",aButtons:[{sExtends:"pdf",sPdfOrientation:"landscape",sTitle:"Relay_Abonnenter"},{sExtends:"xls",sButtonText:"Excel (.csv)",sTitle:"Relay_Abonnenter"}]}]},data:UTILS.convertDataTablesData(u),columns:[{data:"userDisplayName",render:function(e,t,a,n){return'<a class="userTableMoreInfo icon ion-ios-email" href="mailto:'+a.userEmail+'"> '+e+"</a>"}},{data:"userAffiliation"},{data:"userPresentationCount"},{data:"userPresentationDurationTotalSec",render:function(e,t,a,n){return UTILS.secToTime(e)}},{data:"userHits",render:function(e,t,a,n){var r=parseInt(e)<100?"red":parseInt(e)<500?"yellow":"light-blue";return'<div style="width: 100%;" class="text-center"><span class="badge bg-'+r+'">'+e+"</span></div>"}}]}),$("#usersTableOrg"));g.find(".th-name").html("<span class='label label-default'><i class='ion ion-android-person'></i> = "+t+"</span>"),g.find(".th-type").html("<span class='label label-default'>A="+r+"/S="+s+"</span>"),g.find(".th-usersPresentationsXHR").html("<span class='label label-default'><i class='ion ion-ios-film'></i> = "+e+"</span>"),g.find(".th-duration").html("<span class='label label-default'><i class='ion ion-ios-clock'></i> = "+UTILS.secToTimeAndDays(a)+"</span>"),g.find(".th-hits").html("<span class='label label-default'><i class='ion ion-stats-bars'></i> = "+n+"</span>"),$("#pageOrgAdmin").find("#usersTableBox").find(".ajax").hide()})}function i(){if(o(),g="INGEN",$("#lineChartOrgAlert").hide(),RELAY.orgStorageArr(l).length<2)return $("#lineChartOrgAlert").html("<code>"+d+"</code>&nbsp;&nbsp;har for f&aring; nylige lagringspunkter registrert til &aring; bygge grafen."),$("#lineChartOrgAlert").show(),!1;var e;e=JSON.parse(JSON.stringify(RELAY.orgStorageArr(l))),fillColor="undefined"!=typeof fillColor?fillColor:"#"+(Math.random().toString(16)+"0000000").slice(2,8);var t=30,a=t,n=[],r=[];e.reverse(),$.each(e,function(e,t){var s=new Date(1e3*t.date.sec);if(n.push(s.getUTCDate()+"."+(s.getUTCMonth()+1)+"."+s.getUTCFullYear()),r.push(UTILS.mib2gb(t.size_mib).toFixed(2)),a--,0==a)return!1}),g=t-a,$("#pageOrgAdmin").find(".orgRecordedDatesNum").text(g),r.reverse(),n.reverse();var s={labels:n,datasets:[{label:"Diskforbruk siste "+r.length+" dager",fillColor:fillColor,strokeColor:"#666",pointColor:"#fff",pointStrokeColor:"#666",pointHighlightFill:"#285C85",pointHighlightStroke:"rgba(60,141,188,1)",data:r}]},i=document.getElementById("orgUsageLineChartOrgAdmin").getContext("2d");return new Chart(i).Line(s,{showScale:!0,scaleShowGridLines:!1,scaleShowHorizontalLines:!0,scaleShowVerticalLines:!0,bezierCurve:!0,bezierCurveTension:.3,pointDot:!0,pointDotRadius:4,pointDotStrokeWidth:1,pointHitDetectionRadius:5,datasetStroke:!0,datasetStrokeWidth:2,datasetFill:!0,maintainAspectRatio:!1})}function o(){f!==!1&&(f.destroy(),f=!1)}var l,d,u={},g=0,f=!1;return $("#pageOrgAdmin #btnInvoiceCalc").on("click",r),$("#emailExportOrgAdminModal").on("show.bs.modal",function(e){var t=[];$.each(u,function(e,a){t.push(a.userDisplayName+" <"+a.userEmail+">")}),$("#emailExportOrgAdminModal").find("#emailExportList").html(t.toString())}),$("#dataExportModal").on("show.bs.modal",function(e){if("orgAdmin"===$(e.relatedTarget).data().context){var t=$(this),a=$(e.relatedTarget).data().action;APP.jsonEditor().setName(a),APP.jsonEditor().set("Henter data, vennligst vent..."),$.when(RELAY_ORG.usersXHR(),RELAY_ORG.usersPresentationsXHR()).done(function(e,n){switch(a){case"Brukere":t.find(".modal-title").html('<i class="ion ion-ios-people"></i> Eksporter metadata for alle <strong>brukere</strong>'),APP.jsonEditor().set(UTILS.convertDataTablesData(u));break;case"Opptak":t.find(".modal-title").html('<i class="ion ion-ios-film"></i> Eksporter metadata for alle <strong>opptak</strong>'),APP.jsonEditor().set(n)}})}}),$("#dataExportModal").on("hide.bs.modal",function(e){APP.jsonEditor().set("Henter data, vennligst vent...")}),$("#orgUsageLineChartOrgAdmin").on("click",function(e){f.datasets[0].fillColor="#"+(Math.random().toString(16)+"0000000").slice(2,8),f.update()}),{init:function(){return e()},hide:function(){a()},show:function(){t()}}}();