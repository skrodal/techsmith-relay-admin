var DATAPORTEN=function(){function e(){return DP_AUTH.jso().ajax({url:DP_AUTH.config().dp_endpoints.userinfo,dataType:"json"}).pipe(function(e){var r=e.user,i={};if(i.org={},0==r.userid_sec.length||r.userid_sec[0].indexOf("feide:")==-1)return UTILS.showAuthError("Brukerinfo","Tjenesten krever pålogging med Feide. Fant ikke ditt Feide brukernavn."),!1;var n=r.userid_sec[0].split("feide:")[1].toLowerCase(),t=n.split("@")[1];return i.id=r.userid,i.username=n,i.name={full:r.name,first:r.name.split(" ")[0]},i.email=r.email,i.photo=DP_AUTH.config().dp_endpoints.photo+r.profilephoto,i.org.id=t,i.org.shortname=t.split(".")[0],UTILS.updateAuthProgress("Brukerinfo"),UTILS.showAuthInfo("Feide Brukerinfo",n),i}).fail(function(e,r,i){UTILS.showAuthError("Brukerinfo",e)})}function r(){return DP_AUTH.jso().ajax({url:DP_AUTH.config().api_endpoints.relay+"me/role/",dataType:"json"}).pipe(function(e){var r={};return r.role=e.data,UTILS.showAuthInfo("SuperAdmin",e.data.isSuperAdmin),UTILS.showAuthInfo("OrgAdmin",e.data.isOrgAdmin),UTILS.showAuthInfo("Rolle",e.data.title),r}).fail(function(e,r,i){UTILS.alertError("Relay API (version):","Henting av brukerrolle feilet.")})}function i(){return DP_AUTH.jso().ajax({url:DP_AUTH.config().api_endpoints.relay+"org/"+DATAPORTEN.user().org.shortname+"/orgadmin/invitationurl/",datatype:"json"}).pipe(function(e){return e.data}).fail(function(e,r,i){var n="Relay API — <code>org/"+DATAPORTEN.user().org.shortname+"/orgadmin/invitationurl/</code>",t="Relay API avslo forespørselen - timeout eller manglende rettigheter?";UTILS.alertError(n,t),UTILS.showAuthError(n,t)})}function n(){return DP_AUTH.jso().ajax({url:DP_AUTH.config().dp_endpoints.groups+"me/groups",dataType:"json"}).pipe(function(e){var r={};if(r.affiliation=null,r.org={},r.org.name=null,0===e.length)return UTILS.showAuthError("Mangler rettigheter","Du har dessverre ikke tilgang til denne tjenesten (fikk ikke tak i din tilhørighet)"),!1;if($.each(e,function(e,i){if(void 0!==i.orgType&&void 0!==i.type&&i.orgType.indexOf("higher_education")>=0&&"FC:ORG"===i.type.toUpperCase())return r.affiliation=i.membership.primaryAffiliation,r.affiliation instanceof Array&&(r.affiliation=r.affiliation[0]),r.affiliation=r.affiliation.toLowerCase(),r.org.name=i.displayName,!1}),!r.affiliation){var i="Fikk ikke tak i din tilh&oslash;righet (eks. 'ansatt'/'student')";return $.Deferred().reject(i,i,i).promise()}return UTILS.updateAuthProgress("Grupper"),UTILS.showAuthInfo("Feide Tilhørighet",r.affiliation),r}).fail(function(e,r,i){UTILS.showAuthError("Grupper",e)})}var t=$.Deferred(),o={},a=e(),u=r(),f=n();return function(){$.when(a,u,f).done(function(e,r,i){0==e&&t.reject("Fant ikke Feide brukernavn."),$.extend(!0,o,e),$.extend(!0,o,r),$.extend(!0,o,i),t.resolve()})}(),{READY:function(){return t},user:function(){return o},isSuperAdmin:function(){return o.role.isSuperAdmin},isOrgAdmin:function(){return o.role.isOrgAdmin},userRole:function(){return o.role.title},orgAdminInvitationLinkXHR:function(){return!DATAPORTEN.isOrgAdmin()||i()},isEmployee:function(){return"employee"===o.affiliation.toLowerCase()},isStudent:function(){return"student"===o.affiliation.toLowerCase()},affiliation:function(){return o.affiliation.toLowerCase()}}}();