var DATAPORTEN=function(){function e(){return DP_AUTH.jso().ajax({url:DP_AUTH.config().dp_endpoints.userinfo,dataType:"json"}).pipe(function(e){var n=e.user,r={};if(r.org={},n.userid_sec[0].indexOf("feide:")==-1)return UTILS.showAuthError("Brukerinfo","Tjenesten krever pålogging med Feide. Fant ikke ditt Feide brukernavn."),!1;var i=n.userid_sec[0].split("feide:")[1].toLowerCase(),t=i.split("@")[1];return r.id=n.userid,r.username=i,r.name={full:n.name,first:n.name.split(" ")[0]},r.email=n.email,r.photo=DP_AUTH.config().dp_endpoints.photo+n.profilephoto,r.org.id=t,r.org.shortname=t.split(".")[0],UTILS.updateAuthProgress("Brukerinfo"),UTILS.showAuthInfo("Feide Brukerinfo",i),r}).fail(function(e,n,r){UTILS.showAuthError("Brukerinfo",e)})}function n(){return DP_AUTH.jso().ajax({url:DP_AUTH.config().api_endpoints.relay+"me/role/",dataType:"json"}).pipe(function(e){var n={};return n.role=e.data,UTILS.showAuthInfo("SuperAdmin",e.data.isSuperAdmin),UTILS.showAuthInfo("OrgAdmin",e.data.isOrgAdmin),UTILS.showAuthInfo("Rolle",e.data.title),n}).fail(function(e,n,r){UTILS.alertError("Relay API (version):","Henting av brukerrolle feilet.")})}function r(){return DP_AUTH.jso().ajax({url:DP_AUTH.config().api_endpoints.relay+"org/"+DATAPORTEN.user().org.shortname+"/orgadmin/invitationurl/",datatype:"json"}).pipe(function(e){return e.data}).fail(function(e,n,r){var i="Relay API — <code>org/"+DATAPORTEN.user().org.shortname+"/orgadmin/invitationurl/</code>",t="Relay API avslo forespørselen - timeout eller manglende rettigheter?";UTILS.alertError(i,t),UTILS.showAuthError(i,t)})}function i(){return DP_AUTH.jso().ajax({url:DP_AUTH.config().dp_endpoints.groups+"me/groups",dataType:"json"}).pipe(function(e){var n=e,r={};if(r.affiliation=null,r.org={},r.org.name=null,0===n.length)UTILS.showAuthError("Mangler rettigheter","Du har dessverre ikke tilgang til denne tjenesten (fikk ikke tak i din tilhørighet)");else{if($.each(n,function(e,n){if(void 0!==n.orgType&&void 0!==n.type&&n.orgType.indexOf("higher_education")>=0&&"FC:ORG"===n.type.toUpperCase())return r.affiliation=n.membership.primaryAffiliation,r.affiliation instanceof Array&&(r.affiliation=r.affiliation[0]),r.affiliation=r.affiliation.toLowerCase(),r.org.name=n.displayName,!1}),!r.affiliation){var i="Fikk ikke tak i din tilh&oslash;righet (eks. 'ansatt'/'student')";return $.Deferred().reject(i,i,i).promise()}UTILS.updateAuthProgress("Grupper"),UTILS.showAuthInfo("Feide Tilhørighet",r.affiliation)}return r}).fail(function(e,n,r){UTILS.showAuthError("Grupper",e)})}var t={},o=e(),a=n(),u=i();return function(){$.when(o).done(function(e){$.extend(!0,t,e)}),$.when(a).done(function(e){$.extend(!0,t,e)}),$.when(u).done(function(e){$.extend(!0,t,e)})}(),{readyUser:function(){return o},readyUserRole:function(){return a},readyGroups:function(){return u},user:function(){return t},isSuperAdmin:function(){return t.role.isSuperAdmin},isOrgAdmin:function(){return t.role.isOrgAdmin},userRole:function(){return t.role.title},orgAdminInvitationLinkXHR:function(){return!DATAPORTEN.isOrgAdmin()||r()},isEmployee:function(){return"employee"===t.affiliation.toLowerCase()},isStudent:function(){return"student"===t.affiliation.toLowerCase()},affiliation:function(){return t.affiliation.toLowerCase()}}}();