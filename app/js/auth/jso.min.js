!function(e,t){"function"==typeof define&&define.amd?define([],t):e.JSO=t()}(this,function(){var e,t,n;return function(o){function r(e,t){return w.call(e,t)}function i(e,t){var n,o,r,i,s,a,c,u,f,l,p,g=t&&t.split("/"),h=k.map,d=h&&h["*"]||{};if(e&&"."===e.charAt(0))if(t){for(g=g.slice(0,g.length-1),e=e.split("/"),s=e.length-1,k.nodeIdCompat&&b.test(e[s])&&(e[s]=e[s].replace(b,"")),e=g.concat(e),f=0;f<e.length;f+=1)if(p=e[f],"."===p)e.splice(f,1),f-=1;else if(".."===p){if(1===f&&(".."===e[2]||".."===e[0]))break;f>0&&(e.splice(f-1,2),f-=2)}e=e.join("/")}else 0===e.indexOf("./")&&(e=e.substring(2));if((g||d)&&h){for(n=e.split("/"),f=n.length;f>0;f-=1){if(o=n.slice(0,f).join("/"),g)for(l=g.length;l>0;l-=1)if(r=h[g.slice(0,l).join("/")],r&&(r=r[o])){i=r,a=f;break}if(i)break;!c&&d&&d[o]&&(c=d[o],u=f)}!i&&c&&(i=c,a=u),i&&(n.splice(0,a,i),e=n.join("/"))}return e}function s(e,t){return function(){return g.apply(o,S.call(arguments,0).concat([e,t]))}}function a(e){return function(t){return i(t,e)}}function c(e){return function(t){x[e]=t}}function u(e){if(r(v,e)){var t=v[e];delete v[e],y[e]=!0,p.apply(o,t)}if(!r(x,e)&&!r(y,e))throw new Error("No "+e);return x[e]}function f(e){var t,n=e?e.indexOf("!"):-1;return n>-1&&(t=e.substring(0,n),e=e.substring(n+1,e.length)),[t,e]}function l(e){return function(){return k&&k.config&&k.config[e]||{}}}var p,g,h,d,x={},v={},k={},y={},w=Object.prototype.hasOwnProperty,S=[].slice,b=/\.js$/;h=function(e,t){var n,o=f(e),r=o[0];return e=o[1],r&&(r=i(r,t),n=u(r)),r?e=n&&n.normalize?n.normalize(e,a(t)):i(e,t):(e=i(e,t),o=f(e),r=o[0],e=o[1],r&&(n=u(r))),{f:r?r+"!"+e:e,n:e,pr:r,p:n}},d={require:function(e){return s(e)},exports:function(e){var t=x[e];return"undefined"!=typeof t?t:x[e]={}},module:function(e){return{id:e,uri:"",exports:x[e],config:l(e)}}},p=function(e,t,n,i){var a,f,l,p,g,k,w=[],S=typeof n;if(i=i||e,"undefined"===S||"function"===S){for(t=!t.length&&n.length?["require","exports","module"]:t,g=0;g<t.length;g+=1)if(p=h(t[g],i),f=p.f,"require"===f)w[g]=d.require(e);else if("exports"===f)w[g]=d.exports(e),k=!0;else if("module"===f)a=w[g]=d.module(e);else if(r(x,f)||r(v,f)||r(y,f))w[g]=u(f);else{if(!p.p)throw new Error(e+" missing "+f);p.p.load(p.n,s(i,!0),c(f),{}),w[g]=x[f]}l=n?n.apply(x[e],w):void 0,e&&(a&&a.exports!==o&&a.exports!==x[e]?x[e]=a.exports:l===o&&k||(x[e]=l))}else e&&(x[e]=n)},e=t=g=function(e,t,n,r,i){if("string"==typeof e)return d[e]?d[e](t):u(h(e,t).f);if(!e.splice){if(k=e,k.deps&&g(k.deps,k.callback),!t)return;t.splice?(e=t,t=n,n=null):e=o}return t=t||function(){},"function"==typeof n&&(n=r,r=i),r?p(o,e,t,n):setTimeout(function(){p(o,e,t,n)},4),g},g.config=function(e){return g(e)},e._defined=x,n=function(e,t,n){t.splice||(n=t,t=[]),r(x,e)||r(v,e)||(v[e]=[e,t,n])},n.amd={jQuery:!0}}(),n("almond",function(){}),n("utils",["require","exports","module"],function(e,t,n){var o={},r=!0;return o.setDebug=function(e){r=e},o.epoch=function(){return Math.round((new Date).getTime()/1e3)},o.uuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0,n="x"==e?t:3&t|8;return n.toString(16)})},o.parseQueryString=function(e){for(var t,n=/\+/g,o=/([^&;=]+)=?([^&;]*)/g,r=function(e){return decodeURIComponent(e.replace(n," "))},i=e,s={};t=o.exec(i);)s[r(t[1])]=r(t[2]);return s},o.scopeList=function(e){return o.uniqueList(e).join(" ")},o.uniqueList=function(e){for(var t={},n=[],o=0;o<e.length;o++)t[e[o]]=1;for(var r in t)t.hasOwnProperty(r)&&n.push(r);return n},o.uuid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0,n="x"==e?t:3&t|8;return n.toString(16)})},o.log=function(e){r&&console&&console.log&&(arguments.length>1?console.log(arguments):console.log(e))},o.encodeURL=function(e,t){var n,o=e,r=0,i=e.indexOf("?")===-1?"?":"&";for(n in t)o+=(0===r++?i:"&")+encodeURIComponent(n)+"="+encodeURIComponent(t[n]);return o},o.epoch=function(){return Math.round((new Date).getTime()/1e3)},o}),n("store",["require","exports","module","./utils"],function(e,t,n){var o=e("./utils"),r={},i=!0;r.setDebug=function(e){i=e},r.saveState=function(e,t){localStorage.setItem("state-"+e,JSON.stringify(t))},r.getState=function(e){var t=JSON.parse(localStorage.getItem("state-"+e));return localStorage.removeItem("state-"+e),t};var s=function(e){i&&console&&console.log&&(arguments.length>1?console.log(arguments):console.log(e))};return r.hasScope=function(e,t){var n;if(!e.scopes)return!1;for(n=0;n<e.scopes.length;n++)if(e.scopes[n]===t)return!0;return!1},r.filterTokens=function(e,t){var n,i,s,a=[],c=o.epoch();for(t||(t=[]),n=0;n<e.length;n++){for(s=!0,e[n].expires&&e[n].expires<c+1&&(s=!1),i=0;i<t.length;i++)r.hasScope(e[n],t[i])||(s=!1);s&&a.push(e[n])}return a},r.saveTokens=function(e,t){localStorage.setItem("tokens-"+e,JSON.stringify(t))},r.getTokens=function(e){var t=JSON.parse(localStorage.getItem("tokens-"+e));return t||(t=[]),s("Token received",t),t},r.wipeTokens=function(e){localStorage.removeItem("tokens-"+e)},r.saveToken=function(e,t){var n=this.getTokens(e);n=r.filterTokens(n),n.push(t),this.saveTokens(e,n)},r.getToken=function(e,t){var n=this.getTokens(e);return n=r.filterTokens(n,t),n.length<1?null:n[0]},r}),n("Config",[],function(){var e=function(e){for(var t=1;t<e.length;t++)for(var n in e[t])e[t].hasOwnProperty(n)&&(e[0][n]=e[t][n]);return e[0]},t=function(){for(var t=[{}],n=0;n<arguments.length;n++)t.push(arguments[n]);this.config=e(t)};return t.prototype.has=function(e){var t=this.config,n=e.split("."),o=0;for(o=0;o<n.length;o++){if(!t.hasOwnProperty(n[o]))return!1;t=t[n[o]]}return!0},t.prototype.get=function(e,t,n){n=n||!1;var o=this.config,r=e.split("."),i=0;for(i=0;i<r.length;i++){if(!o.hasOwnProperty(r[i])){o=void 0;break}o=o[r[i]]}if("undefined"==typeof o){if(n)throw new Error("Configuration option ["+r[i]+"] required but not provided.");return t}return o},t}),n("jso",["require","exports","module","./store","./utils","./Config"],function(e,t,n){var o={lifetime:3600,debug:!0},r=e("./store"),i=e("./utils"),s=e("./Config"),a=function(e){this.config=new s(o,e),this.providerID=this.getProviderID(),i.setDebug(this.config.config.debug),r.setDebug(this.config.config.debug),a.instances[this.providerID]=this,this.callbacks={},this.callbacks.redirect=a.redirect};return a.internalStates=[],a.instances={},a.store=r,a.enablejQuery=function(e){a.$=e},a.redirect=function(e,t){window.location=e},a.prototype.inappbrowser=function(e){var t=this;return function(n,o){var r=function(e){return function(n){var r=n.url;i.log("loadstop event triggered, and the url is now "+r),t.URLcontainsToken(r)&&(setTimeout(function(){e.close()},500),t.callback(r,function(){i.log("Closing window ",e),"function"==typeof o&&o()}))}},s="_blank";e.hasOwnProperty("target")&&(s=e.target);var a={};i.log("About to open url "+n);var c=window.open(n,s,a);i.log("URL Loaded... "),c.addEventListener("loadstart",r(c)),i.log("Event listeren ardded... ",c)}},a.prototype.on=function(e,t){if("string"!=typeof e)throw new Error("Registering triggers on JSO must be identified with an event id");if("function"!=typeof t)throw new Error("Registering a callback on JSO must be a function.");this.callbacks[e]=t},a.prototype.getProviderID=function(){var e=this.config.get("providerID",null);if(null!==e)return e;var t=this.config.get("client_id",null,!0),n=this.config.get("authorization",null,!0);return n+"|"+t},a.prototype.URLcontainsToken=function(e){if(e){if(e.indexOf("#")===-1)return!1;h=e.substring(e.indexOf("#"))}return!(h.length<2)&&h.indexOf("access_token")!==-1},a.prototype.callback=function(e,t,n){var o,s,c,u=window.location.hash,f=i.epoch();if(i.log("JSO.prototype.callback() "+e+" callback="+typeof t),e){if(e.indexOf("#")===-1)return;u=e.substring(e.indexOf("#"))}if(!(u.length<2)&&u.indexOf("access_token")!==-1){if(u=u.substring(1),o=i.parseQueryString(u),o.state)s=r.getState(o.state);else{if(!n)throw"Could not get [state] and no default providerid is provided.";s={providerID:n}}if(!s)throw"Could not retrieve state";if(!s.providerID)throw"Could not get providerid from state";if(!a.instances[s.providerID])throw"Could not retrieve JSO.instances for this provider.";c=a.instances[s.providerID],!o.state&&co.scope&&(s.scopes=c._getRequestScopes(),i.log("Setting state: ",s)),i.log("Checking atoken ",o," and instance ",c),o.expires_in?o.expires=f+parseInt(o.expires_in,10):c.config.get("default_lifetime",null)===!1||(c.config.has("permanent_scope")?r.hasScope(o,c.config.get("permanent_scope"))||(o.expires=f+15768e4):c.config.has("default_lifetime")?o.expires=f+c.config.get("default_lifetime"):o.expires=f+3600),o.scope?o.scopes=o.scope.split(" "):s.scopes&&(o.scopes=s.scopes),r.saveToken(s.providerID,o),s.restoreHash?window.location.hash=s.restoreHash:window.location.hash="",i.log(o),i.log("Looking up internalStates storage for a stored callback... ","state="+o.state,a.internalStates),a.internalStates[o.state]&&"function"==typeof a.internalStates[o.state]&&(i.log("InternalState is set, calling it now!"),a.internalStates[o.state](o),delete a.internalStates[o.state]),i.log("Successfully obtain a token, now call the callback, and may be the window closes",t),"function"==typeof t&&t(o)}},a.prototype.dump=function(){var e="",t=r.getTokens(this.providerID);return e+="Tokens: \n"+JSON.stringify(t,void 0,4)+"\n\n",e+="Config: \n"+JSON.stringify(this.config,void 0,4)+"\n\n"},a.prototype._getRequestScopes=function(e){var t,n=[];if(this.config.scopes&&this.config.scopes.request)for(t=0;t<this.config.scopes.request.length;t++)n.push(this.config.scopes.request[t]);if(e&&e.scopes&&e.scopes.request)for(t=0;t<e.scopes.request.length;t++)n.push(e.scopes.request[t]);return i.uniqueList(n)},a.prototype._getRequiredScopes=function(e){var t,n=[];if(this.config.scopes&&this.config.scopes.require)for(t=0;t<this.config.scopes.require.length;t++)n.push(this.config.scopes.require[t]);if(e&&e.scopes&&e.scopes.require)for(t=0;t<e.scopes.require.length;t++)n.push(e.scopes.require[t]);return i.uniqueList(n)},a.prototype.getToken=function(e,t){var n=this._getRequiredScopes(t),o=r.getToken(this.providerID,n);return o?e(o):void this._authorize(e,t)},a.prototype.checkToken=function(e){var t=this._getRequiredScopes(e);return r.getToken(this.providerID,t)},a.prototype._authorize=function(e,t){var n,o,s,c=this.config.get("authorization",null,!0),u=this.config.get("client_id",null,!0);i.log("About to send an authorization request to this entry:",c),i.log("Options",t,"callback",e),n={response_type:"token",state:i.uuid()},e&&"function"==typeof e&&(i.log("About to store a callback for later with state="+n.state,e),a.internalStates[n.state]=e),this.config.has("redirect_uri")&&(n.redirect_uri=this.config.get("redirect_uri","")),n.client_id=u,s=this._getRequestScopes(t),s.length>0&&(n.scope=i.scopeList(s)),i.log("DEBUG REQUEST"),i.log(n),o=i.encodeURL(c,n),window.location.hash&&(n.restoreHash=window.location.hash),n.providerID=this.providerID,s&&(n.scopes=s),i.log("Saving state ["+n.state+"]"),i.log(JSON.parse(JSON.stringify(n))),r.saveState(n.state,n),this.gotoAuthorizeURL(o,e)},a.prototype.gotoAuthorizeURL=function(e,t){if(!this.callbacks.redirect||"function"!=typeof this.callbacks.redirect)throw new Error("Cannot redirect to authorization endpoint because of missing redirect handler");this.callbacks.redirect(e,t)},a.prototype.wipeTokens=function(){r.wipeTokens(this.providerID)},a.prototype.ajax=function(e){var t,n=this;if(!a.hasOwnProperty("$"))throw new Error("JQuery support not enabled.");oauthOptions=e.oauth||{};var o=e.error||null;return e.error=function(e,r,s){i.log("error(jqXHR, textStatus, errorThrown)"),i.log(e),i.log(r),i.log(s),401===e.status&&(i.log("Token expired. About to delete this token"),i.log(t),n.wipeTokens()),o&&"function"==typeof o&&o(e,r,s)},this.getToken(function(t){return i.log("Ready. Got an token, and ready to perform an AJAX call",t),"qs"===n.config.get("presenttoken",null)?(e.data||(e.data={}),e.data.access_token=t.access_token):(e.headers||(e.headers={}),e.headers.Authorization="Bearer "+t.access_token),i.log("$.ajax settings",e),a.$.ajax(e)},oauthOptions)},a}),t("jso")});