var PAGE_SUPER_ADMIN=function(){function t(){m=DATAPORTEN.user().org.id,p=l(),e()}function e(){$("ul#orgListSuperAdmin").html(""),$.each(KIND.subscribingOrgNames(),function(t,e){$("ul#orgListSuperAdmin").append('<li class="orgLineChartSelector" style="cursor: pointer;" data-org="'+e+'">'+e+"</li>")}),$("#pageSuperAdmin").find(".selectedOrg").html("<code>"+m+"</code>"),$("#pageSuperAdmin").find(".selectedOrgRecordedDatesNum").text(h),$("#pageSuperAdmin").find("#inputCostTB").val(RELAY.storageCostTB()),$("#pageSuperAdmin").find(".costTB").text("kr. "+RELAY.storageCostTB()),$.when(RELAY.serviceStorageXHR()).done(function(t){var e=t;$("#pageSuperAdmin").find(".totalStorageCostEstimate").text("kr. "+(UTILS.mib2tb(e)*RELAY.storageCostTB()).toFixed());var n=RELAY.orgStorageTotalMiB(m),o=n/e*100;$("#pageSuperAdmin").find(".orgTotalStorage").text(UTILS.mib2gb(n).toFixed(2)+" GB"),$("#pageSuperAdmin").find(".orgStoragePercentageGlobal").text(o.toFixed(2)),$("#pageSuperAdmin").find(".orgUserCount").text(RELAY.orgUserCount(m)),$("#pageSuperAdmin").find(".orgSubscriptionStatus").html('<span class="label bg-'+KIND.subscriptionCodesToColors()[KIND.orgSubscriptionStatusCode(m)]+'">'+KIND.subscriptionCodesToNames()[KIND.orgSubscriptionStatusCode(m)]+"</span>"),$("#pageSuperAdmin").find(".orgInvoiceEstimate").text("kr. "+(UTILS.mib2tb(n)*RELAY.storageCostTB()).toFixed(2)),$("#pageSuperAdmin").find(".orgPresentationCount").html('<i class="fa fa-spinner fa-pulse"></i>'),$("#pageSuperAdmin").find(".orgPresentationCount").html(RELAY.orgPresentationCount(m))})}function n(){$.when(RELAY.ready().done(function(){g=a(RELAY.subscribersInfo()),$("#pageSuperAdmin").find("#usersPie").find(".ajax").hide(),f=s(m)})),e()}function o(){i(),d()}function r(t){return RELAY.subscribersInfo()[t]?(m=t,!0):(UTILS.alertError("Fant ikke data for <code>"+t+"</code>","Fant ikke noe data for organisasjonen du valgte: "+t),!1)}function a(t){i();var e=[];$.each(t,function(t,n){e.push({value:n.users,color:"#"+(Math.random().toString(16)+"0000000").slice(2,8),highlight:"#"+(Math.random().toString(16)+"0000000").slice(2,8),label:t})});var n=document.getElementById("chartOrgsUserCountSuperAdmin").getContext("2d");return new Chart(n).Pie(e,{})}function i(){g!==!1&&(g.destroy(),g=!1,$("#pageSuperAdmin").find("#usersPie").find(".ajax").show())}function s(t,e){if(d(),$("#lineChartAlert").hide(),RELAY.orgStorageArr(t).length<2)return $("#lineChartAlert").html("<code>"+t+"</code>&nbsp;&nbsp;har for f&aring; nylige lagringspunkter registrert til &aring; bygge grafen."),$("#lineChartAlert").show(),h="INGEN",!1;var n;n=JSON.parse(JSON.stringify(RELAY.orgStorageArr(t))),e="undefined"!=typeof e?e:"#"+(Math.random().toString(16)+"0000000").slice(2,8);var o=30,r=o,a=[],i=[];n.reverse(),$.each(n,function(t,e){var n=new Date(1e3*e.date.sec);if(a.push(n.getUTCDate()+"."+(n.getUTCMonth()+1)+"."+n.getUTCFullYear()),i.push(UTILS.mib2gb(e.size_mib).toFixed(2)),r--,0==r)return!1}),h=o-r,i.reverse(),a.reverse();var s={labels:a,datasets:[{label:"Diskforbruk siste "+i.length+" dager",fillColor:e,strokeColor:"#666",pointColor:"#fff",pointStrokeColor:"#666",pointHighlightFill:"#285C85",pointHighlightStroke:"rgba(60,141,188,1)",data:i}]},l=document.getElementById("orgUsageLineChartSuperAdmin").getContext("2d");return new Chart(l).Line(s,{showScale:!0,scaleShowGridLines:!1,scaleShowHorizontalLines:!0,scaleShowVerticalLines:!0,bezierCurve:!0,bezierCurveTension:.3,pointDot:!0,pointDotRadius:4,pointDotStrokeWidth:1,pointHitDetectionRadius:5,datasetStroke:!0,datasetStrokeWidth:2,datasetFill:!0,maintainAspectRatio:!1})}function d(){f!==!1&&(f.destroy(),f=!1)}function l(){var t=JSON.parse(JSON.stringify(KIND.subscribers()));$.each(t,function(t,e){var n=RELAY.orgStorageTotalMiB(t),o=RELAY.orgUserCount(t);e.storage={mib:n,gb:UTILS.mib2gb(n).toFixed(2),percentage:(n/RELAY.serviceStorageXHR()*100).toFixed(),cost:(UTILS.mib2tb(n)*RELAY.storageCostTB()).toFixed()},e.userCount=o});var e=$("#pageSuperAdmin").find("#subscribersTableSuperAdmin").DataTable({language:CONFIG.DATATABLES_LANGUAGE(),bAutoWidth:!0,sDom:'T<"clear">lfrtip',oTableTools:{sSwfPath:"dist/plugins/datatables/tabletools/swf/copy_csv_xls_pdf.swf",aButtons:[{sExtends:"copy",sButtonText:"Kopier"},{sExtends:"collection",sButtonText:"Lagre",aButtons:[{sExtends:"pdf",sPdfOrientation:"landscape",sTitle:"Relay_Abonnenter"},{sExtends:"xls",sButtonText:"Excel (.csv)",sTitle:"Relay_Abonnenter"}]}]},data:UTILS.convertDataTablesData(t),columns:[{data:"org_id",render:function(t,e,n,o){return n.org_id}},{data:"contact_person",render:function(t,e,n,o){var r;try{r='<a class="icon ion-ios-email" href="mailto:'+n.contact_person.e_post.toLowerCase()+'"> '+n.contact_person.navn+"</a>"}catch(t){r="<span class='label bg-red'>MANGLER!</span>"}return r}},{data:"contact_support",render:function(t,e,n,o){var r;try{r=n.contact_support.e_post.indexOf("http")==-1?'<a class="icon ion-ios-email" href="mailto:'+n.contact_support.e_post.toLowerCase()+'"> '+n.contact_support.navn+"</a>":'<a class="icon ion-android-open" href="'+n.contact_support.e_post.toLowerCase()+'" target="_blank"> '+n.contact_support.navn+"</a>"}catch(t){r="<span class='label bg-red'>MANGLER!</span>"}return r}},{data:"userCount",width:"5%",render:function(t,e,n,o){return n.userCount}},{data:"storage",width:"5%",render:function(t,e,n,o){return'<div class="progress no-margin"><div class="progress-bar bg-gray tablePercentage" style="width: '+n.storage.percentage+'%">'+n.storage.gb+"</div></div>"}},{data:"storage",width:"5%",render:function(t,e,n,o){return'<span class="text-muted">'+n.storage.cost+"kr</span>"}},{data:"subscription_code",width:"5%",render:function(t,e,n,o){return"<span class='label bg-"+KIND.subscriptionCodesToColors()[n.subscription_code]+"'>"+KIND.subscriptionCodesToNames()[n.subscription_code]+"</span>"}}]});return $("#pageSuperAdmin").find("#subscribersTableBox").find(".ajax").hide(),e}function c(t){var e=t,n=$("#emailExportSuperAdminModal");n.find("#emailExportTargetGroup").html(e.data("exportGroup")),n.find("#emailMissing").html(""),n.find("#emailExportCount").html(""),n.find("#emailExportList").html("Henter liste, vennligst vent....");var o=[];if("brukere"===e.data("exportGroup"))$.when(RELAY.orgUserListXHR(m)).then(function(t){$.each(t,function(t,e){o.push(e.displayname+" <"+e.email+">")}),n.find("#emailExportCount").html(o.length),n.find("#emailExportList").html(o.toString())});else{var r,a="",i={count:0,orgs:""};$.each(KIND.subscribers(),function(t,n){r="kontaktpersoner"===e.data("exportGroup")?n.contact_person:n.contact_support,null===r||20!=n.subscription_code&&15!=n.subscription_code?(i.count++,i.orgs+="<span class='label bg-red'>"+n.org_id+"</span> "):null!==r.e_post&&r.e_post.indexOf("http")==-1?(a="<"+r.e_post.trim()+">",null!==r.navn&&(a=r.navn.trim()+" "+a),o.push(a)):(i.count++,i.orgs+="<span class='label bg-red'>"+n.org_id+"</span> ")}),n.find("#emailExportCount").html(o.length),n.find("#emailExportList").html(o.toString()),i.count>0&&$("#emailExportSuperAdminModal").find("#emailMissing").html("<span class='badge bg-red'>"+i.count+"</span> mangler kontaktadresse: <br/>"+i.orgs)}}function u(){var t=$("#pageSuperAdmin").find("#inputCostTB").val();RELAY.setStorageCost(t)&&(e(),p.destroy(),p=l())}var p,g=!1,f=!1,m="",h=0;return $("#chartOrgsUserCountSuperAdmin").on("click",function(t){var n=g.getSegmentsAtEvent(t);r(n[0].label)&&(f=s(m,n[0]._saved.fillColor),e(),$("html, body").animate({scrollTop:$("#orgDetailsHeader").offset().top+"px"},"fast"))}),$("ul#orgListSuperAdmin").on("click","li.orgLineChartSelector",function(){r($(this).data("org"))&&(f=s(m),e())}),$("#orgUsageLineChartSuperAdmin").on("click",function(t){f.datasets[0].fillColor="#"+(Math.random().toString(16)+"0000000").slice(2,8),f.update()}),$(".email_export").on("click",function(){c($(this))}),$("#dataExportModal").on("show.bs.modal",function(t){if("superAdmin"===$(t.relatedTarget).data().context){var e=$(this),n=$(t.relatedTarget).data().action;switch(APP.jsonEditor().setName(n),APP.jsonEditor().set("Henter data, vennligst vent..."),n){case"Brukere":e.find(".modal-title").html('<i class="ion ion-ios-people"></i> Eksporter metadata for alle <strong>brukere</strong> ved <code>'+m+"</code>"),e.find("#legend_users").fadeIn(),$.when(RELAY.orgUserListXHR(m)).then(function(t){APP.jsonEditor().set(t)});break;case"Opptak":e.find(".modal-title").html('<i class="ion ion-ios-film"></i> Eksporter metadata for alle <strong>opptak</strong> fra <code>'+m+"</code>"),e.find("#legend_users").hide(),$.when(RELAY.orgPresentationListXHR(m)).then(function(t){APP.jsonEditor().set(t)})}}}),$("#dataExportModal").on("hide.bs.modal",function(t){APP.jsonEditor().set("Henter data, vennligst vent...")}),$("#pageSuperAdmin #btnInvoiceCalc").on("click",u),{init:function(){return t()},hide:function(){o()},show:function(){n()}}}();