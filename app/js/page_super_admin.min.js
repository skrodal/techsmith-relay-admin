var PAGE_SUPER_ADMIN=function(){function e(){h=DATAPORTEN.user().org.id,g=u(),t(),a()}function t(){$("ul#orgListSuperAdmin").html(""),$.each(KIND.subscribingOrgNames(),function(e,t){$("ul#orgListSuperAdmin").append('<li class="orgLineChartSelector" style="cursor: pointer;" data-org="'+t+'">'+t+"</li>")}),$("#pageSuperAdmin").find(".selectedOrg").html("<code>"+h+"</code>"),$("#pageSuperAdmin").find(".selectedOrgRecordedDatesNum").text(b),$("#pageSuperAdmin").find("#inputCostTB").val(RELAY.storageCostTB()),$("#pageSuperAdmin").find(".costTB").text("kr. "+RELAY.storageCostTB()),$.when(RELAY.serviceStorageXHR()).done(function(e){var t=e;$("#pageSuperAdmin").find(".totalStorageCostEstimate").text("kr. "+(UTILS.mib2tb(t)*RELAY.storageCostTB()).toFixed());var n=RELAY.orgStorageTotalMiB(h),o=n/t*100;$("#pageSuperAdmin").find(".orgTotalStorage").text(UTILS.mib2gb(n).toFixed(2)+" GB"),$("#pageSuperAdmin").find(".orgStoragePercentageGlobal").text(o.toFixed(2)),$("#pageSuperAdmin").find(".orgUserCount").text(RELAY.orgUserCount(h)),$("#pageSuperAdmin").find(".orgSubscriptionStatus").html('<span class="label bg-'+KIND.subscriptionCodesToColors()[KIND.orgSubscriptionStatusCode(h)]+'">'+KIND.subscriptionCodesToNames()[KIND.orgSubscriptionStatusCode(h)]+"</span>"),$("#pageSuperAdmin").find(".orgInvoiceEstimate").text("kr. "+(UTILS.mib2tb(n)*RELAY.storageCostTB()).toFixed(2)),$("#pageSuperAdmin").find(".orgPresentationCount").html('<i class="fa fa-spinner fa-pulse"></i>'),$("#pageSuperAdmin").find(".orgPresentationCount").html(RELAY.orgPresentationCount(h))})}function n(){$.when(RELAY.ready().done(function(){f=i(RELAY.subscribersInfo()),$("#pageSuperAdmin").find("#usersPie").find(".ajax").hide(),m=d(h)})),t()}function o(){s(),l()}function r(e){return RELAY.subscribersInfo()[e]?(h=e,!0):(UTILS.alertError("Fant ikke data for <code>"+e+"</code>","Fant ikke noe data for organisasjonen du valgte: "+e),!1)}function a(){$("#pageSuperAdmin").find("#queueFailedJobsContainer").find(".ajax").show(),$("#pageSuperAdmin").find("#queueFailedJobsTable").hide(),$.when(RELAY.serviceQueueFailedJobsXHR()).done(function(e){var t=e.length;$("#pageSuperAdmin").find(".queueFailedJobsCount").text(t),t>0&&($("#pageSuperAdmin").find("#queueFailedJobsTableBody").html(""),$.each(e,function(e,t){$("#pageSuperAdmin").find("#queueFailedJobsTableBody").append("<tr><td>"+t.jobPresentation_PresId+"</td><td>"+t.jobNumberOfFailures+"</td><td>"+t.jobFailureReason+"</td></tr>")}),$("#pageSuperAdmin").find("#queueFailedJobsTable").show()),$("#pageSuperAdmin").find("#queueFailedJobsContainer").find(".ajax").hide()})}function i(e){s();var t=[];$.each(e,function(e,n){t.push({value:n.users,color:"#"+(Math.random().toString(16)+"0000000").slice(2,8),highlight:"#"+(Math.random().toString(16)+"0000000").slice(2,8),label:e})});var n=document.getElementById("chartOrgsUserCountSuperAdmin").getContext("2d");return new Chart(n).Pie(t,{})}function s(){f!==!1&&(f.destroy(),f=!1,$("#pageSuperAdmin").find("#usersPie").find(".ajax").show())}function d(e,t){if(l(),$("#lineChartAlert").hide(),RELAY.orgStorageArr(e).length<2)return $("#lineChartAlert").html("<code>"+e+"</code>&nbsp;&nbsp;har for f&aring; nylige lagringspunkter registrert til &aring; bygge grafen."),$("#lineChartAlert").show(),b="INGEN",!1;var n;n=JSON.parse(JSON.stringify(RELAY.orgStorageArr(e))),t="undefined"!=typeof t?t:"#"+(Math.random().toString(16)+"0000000").slice(2,8);var o=30,r=o,a=[],i=[];n.reverse(),$.each(n,function(e,t){var n=new Date(1e3*t.date.sec);if(a.push(n.getUTCDate()+"."+(n.getUTCMonth()+1)+"."+n.getUTCFullYear()),i.push(UTILS.mib2gb(t.size_mib).toFixed(2)),r--,0==r)return!1}),b=o-r,i.reverse(),a.reverse();var s={labels:a,datasets:[{label:"Diskforbruk siste "+i.length+" dager",fillColor:t,strokeColor:"#666",pointColor:"#fff",pointStrokeColor:"#666",pointHighlightFill:"#285C85",pointHighlightStroke:"rgba(60,141,188,1)",data:i}]},d=document.getElementById("orgUsageLineChartSuperAdmin").getContext("2d");return new Chart(d).Line(s,{showScale:!0,scaleShowGridLines:!1,scaleShowHorizontalLines:!0,scaleShowVerticalLines:!0,bezierCurve:!0,bezierCurveTension:.3,pointDot:!0,pointDotRadius:4,pointDotStrokeWidth:1,pointHitDetectionRadius:5,datasetStroke:!0,datasetStrokeWidth:2,datasetFill:!0,maintainAspectRatio:!1})}function l(){m!==!1&&(m.destroy(),m=!1)}function u(){var e=JSON.parse(JSON.stringify(KIND.subscribers()));$.each(e,function(e,t){var n=RELAY.orgStorageTotalMiB(e),o=RELAY.orgUserCount(e);t.storage={mib:n,gb:UTILS.mib2gb(n).toFixed(2),percentage:(n/RELAY.serviceStorageXHR()*100).toFixed(),cost:(UTILS.mib2tb(n)*RELAY.storageCostTB()).toFixed()},t.userCount=o});var t=$("#pageSuperAdmin").find("#subscribersTableSuperAdmin").DataTable({language:CONFIG.DATATABLES_LANGUAGE(),bAutoWidth:!0,sDom:'T<"clear">lfrtip',oTableTools:{sSwfPath:"dist/plugins/datatables/tabletools/swf/copy_csv_xls_pdf.swf",aButtons:[{sExtends:"copy",sButtonText:"Kopier"},{sExtends:"collection",sButtonText:"Lagre",aButtons:[{sExtends:"pdf",sPdfOrientation:"landscape",sTitle:"Relay_Abonnenter"},{sExtends:"xls",sButtonText:"Excel (.csv)",sTitle:"Relay_Abonnenter"}]}]},data:UTILS.convertDataTablesData(e),columns:[{data:"org_id",render:function(e,t,n,o){return n.org_id}},{data:"contact_person",render:function(e,t,n,o){var r;try{r='<a class="icon ion-ios-email" href="mailto:'+n.contact_person.e_post.toLowerCase()+'"> '+n.contact_person.navn+"</a>"}catch(e){r="<span class='label bg-red'>MANGLER!</span>"}return r}},{data:"contact_support",render:function(e,t,n,o){var r;try{r=n.contact_support.e_post.indexOf("http")==-1?'<a class="icon ion-ios-email" href="mailto:'+n.contact_support.e_post.toLowerCase()+'"> '+n.contact_support.navn+"</a>":'<a class="icon ion-android-open" href="'+n.contact_support.e_post.toLowerCase()+'" target="_blank"> '+n.contact_support.navn+"</a>"}catch(e){r="<span class='label bg-red'>MANGLER!</span>"}return r}},{data:"userCount",width:"5%",render:function(e,t,n,o){return n.userCount}},{data:"storage",width:"5%",render:function(e,t,n,o){return'<div class="progress no-margin"><div class="progress-bar bg-gray tablePercentage" style="width: '+n.storage.percentage+'%">'+n.storage.gb+"</div></div>"}},{data:"storage",width:"5%",render:function(e,t,n,o){return'<span class="text-muted">'+n.storage.cost+"kr</span>"}},{data:"subscription_code",width:"5%",render:function(e,t,n,o){return"<span class='label bg-"+KIND.subscriptionCodesToColors()[n.subscription_code]+"'>"+KIND.subscriptionCodesToNames()[n.subscription_code]+"</span>"}}]});return $("#pageSuperAdmin").find("#subscribersTableBox").find(".ajax").hide(),t}function c(e){var t=e,n=$("#emailExportSuperAdminModal");n.find("#emailExportTargetGroup").html(t.data("exportGroup")),n.find("#emailMissing").html(""),n.find("#emailExportCount").html(""),n.find("#emailExportList").html("Henter liste, vennligst vent....");var o=[];if("brukere"===t.data("exportGroup"))$.when(RELAY.orgUserListXHR(h)).then(function(e){$.each(e,function(e,t){o.push(t.displayname+" <"+t.email+">")}),n.find("#emailExportCount").html(o.length),n.find("#emailExportList").html(o.toString())});else{var r,a="",i={count:0,orgs:""};$.each(KIND.subscribers(),function(e,n){r="kontaktpersoner"===t.data("exportGroup")?n.contact_person:n.contact_support,null===r||20!=n.subscription_code&&15!=n.subscription_code?(i.count++,i.orgs+="<span class='label bg-red'>"+n.org_id+"</span> "):null!==r.e_post&&r.e_post.indexOf("http")==-1?(a="<"+r.e_post.trim()+">",null!==r.navn&&(a=r.navn.trim()+" "+a),o.push(a)):(i.count++,i.orgs+="<span class='label bg-red'>"+n.org_id+"</span> ")}),n.find("#emailExportCount").html(o.length),n.find("#emailExportList").html(o.toString()),i.count>0&&$("#emailExportSuperAdminModal").find("#emailMissing").html("<span class='badge bg-red'>"+i.count+"</span> mangler kontaktadresse: <br/>"+i.orgs)}}function p(){var e=$("#pageSuperAdmin").find("#inputCostTB").val();RELAY.setStorageCost(e)&&(t(),g.destroy(),g=u())}var g,f=!1,m=!1,h="",b=0;return $(".refreshQueueFailedJobs").on("click",function(){a()}),$("#chartOrgsUserCountSuperAdmin").on("click",function(e){var n=f.getSegmentsAtEvent(e);r(n[0].label)&&(m=d(h,n[0]._saved.fillColor),t(),$("html, body").animate({scrollTop:$("#orgDetailsHeader").offset().top+"px"},"fast"))}),$("ul#orgListSuperAdmin").on("click","li.orgLineChartSelector",function(){r($(this).data("org"))&&(m=d(h),t())}),$("#orgUsageLineChartSuperAdmin").on("click",function(e){m.datasets[0].fillColor="#"+(Math.random().toString(16)+"0000000").slice(2,8),m.update()}),$(".email_export").on("click",function(){c($(this))}),$("#dataExportModal").on("show.bs.modal",function(e){if("superAdmin"===$(e.relatedTarget).data().context){var t=$(this),n=$(e.relatedTarget).data().action;switch(APP.jsonEditor().setName(n),APP.jsonEditor().set("Henter data, vennligst vent..."),n){case"Brukere":t.find(".modal-title").html('<i class="ion ion-ios-people"></i> Eksporter metadata for alle <strong>brukere</strong> ved <code>'+h+"</code>"),t.find("#legend_users").fadeIn(),$.when(RELAY.orgUserListXHR(h)).then(function(e){APP.jsonEditor().set(e)});break;case"Opptak":t.find(".modal-title").html('<i class="ion ion-ios-film"></i> Eksporter metadata for alle <strong>opptak</strong> fra <code>'+h+"</code>"),t.find("#legend_users").hide(),$.when(RELAY.orgPresentationListXHR(h)).then(function(e){APP.jsonEditor().set(e)})}}}),$("#dataExportModal").on("hide.bs.modal",function(e){APP.jsonEditor().set("Henter data, vennligst vent...")}),$("#pageSuperAdmin #btnInvoiceCalc").on("click",p),{init:function(){return e()},hide:function(){o()},show:function(){n()}}}();