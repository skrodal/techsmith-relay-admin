var PAGE_SUPER_ADMIN=function(){function e(){h=DATAPORTEN.user().org.id,p=u(),t(),i()}function t(){$("ul#orgListSuperAdmin").html(""),$.each(RELAY.subscribersInfo(),function(e,t){$("ul#orgListSuperAdmin").append('<li class="orgLineChartSelector" style="cursor: pointer;" data-org="'+e+'">'+e+"</li>")}),$("#pageSuperAdmin").find(".selectedOrg").html("<code>"+h+"</code>"),$("#pageSuperAdmin").find(".selectedOrgRecordedDatesNum").text(b),$("#pageSuperAdmin").find("#inputCostTB").val(RELAY.storageCostTB()),$("#pageSuperAdmin").find(".costTB").text("kr. "+RELAY.storageCostTB()),$("#pageSuperAdmin").find(".orgUserCount").html(RELAY.orgUserCount(h)+"<br><small class='text-muted'>"+RELAY.orgEmployeesCount(h)+"/"+RELAY.orgStudentsCount(h)+"</small>"),$("#pageSuperAdmin").find(".orgPresentationCount").html(RELAY.orgPresentationCount(h)+"<br><small class='text-muted'>"+RELAY.orgEmployeesPresentationCount(h)+"/"+RELAY.orgStudentsPresentationCount(h)+"</small>"),$.when(RELAY.serviceStorageXHR()).done(function(e){var t=e;$("#pageSuperAdmin").find(".totalStorageCostEstimate").text("kr. "+(UTILS.mib2tb(t)*RELAY.storageCostTB()).toFixed());var n=RELAY.orgStorageTotalMiB(h),r=n/t*100;$("#pageSuperAdmin").find(".orgTotalStorage").text(UTILS.mib2gb(n).toFixed(2)+" GB"),$("#pageSuperAdmin").find(".orgStoragePercentageGlobal").text(r.toFixed(2)),$("#pageSuperAdmin").find(".orgInvoiceEstimate").text("kr. "+(UTILS.mib2tb(n)*RELAY.storageCostTB()).toFixed(2))})}function n(){f=a(RELAY.subscribersInfo()),$("#pageSuperAdmin").find("#usersPie").find(".ajax").hide(),m=d(h),t()}function r(){s(),l()}function o(e){return RELAY.subscribersInfo()[e]?(h=e,!0):(UTILS.alertError("Fant ikke data for <code>"+e+"</code>","Fant ikke noe data for organisasjonen du valgte: "+e),!1)}function i(){$("#pageSuperAdmin").find("#queueFailedJobsContainer").find(".ajax").show(),$("#pageSuperAdmin").find("#queueFailedJobsTable").hide(),$.when(RELAY.serviceQueueFailedJobsXHR()).done(function(e){var t=e.length;$("#pageSuperAdmin").find(".queueFailedJobsCount").text(t),t>0&&($("#pageSuperAdmin").find("#queueFailedJobsTableBody").html(""),$.each(e,function(e,t){$("#pageSuperAdmin").find("#queueFailedJobsTableBody").append("<tr><td>"+t.jobPresentation_PresId+"</td><td>"+t.jobNumberOfFailures+"</td><td>"+t.jobFailureReason+"</td></tr>")}),$("#pageSuperAdmin").find("#queueFailedJobsTable").show()),$("#pageSuperAdmin").find("#queueFailedJobsContainer").find(".ajax").hide()})}function a(e){s();var t=[];$.each(e,function(e,n){t.push({value:n.users.total,color:"#"+(Math.random().toString(16)+"0000000").slice(2,8),highlight:"#"+(Math.random().toString(16)+"0000000").slice(2,8),label:e})});var n=document.getElementById("chartOrgsUserCountSuperAdmin").getContext("2d");return new Chart(n).Pie(t,{})}function s(){f!==!1&&(f.destroy(),f=!1,$("#pageSuperAdmin").find("#usersPie").find(".ajax").show())}function d(e,t){if(l(),$("#lineChartAlert").hide(),null!==RELAY.orgStorageArr(e)&&RELAY.orgStorageArr(e).length>=2){var n;n=JSON.parse(JSON.stringify(RELAY.orgStorageArr(e))),t="undefined"!=typeof t?t:"#"+(Math.random().toString(16)+"0000000").slice(2,8);var r=30,o=r,i=[],a=[];n.reverse(),$.each(n,function(e,t){var n=new Date(1e3*t.date.sec);if(i.push(n.getUTCDate()+"."+(n.getUTCMonth()+1)+"."+n.getUTCFullYear()),a.push(UTILS.mib2gb(t.size_mib).toFixed(2)),o--,0==o)return!1}),b=r-o,a.reverse(),i.reverse();var s={labels:i,datasets:[{label:"Diskforbruk siste "+a.length+" dager",fillColor:t,strokeColor:"#666",pointColor:"#fff",pointStrokeColor:"#666",pointHighlightFill:"#285C85",pointHighlightStroke:"rgba(60,141,188,1)",data:a}]},d=document.getElementById("orgUsageLineChartSuperAdmin").getContext("2d");return new Chart(d).Line(s,{showScale:!0,scaleShowGridLines:!1,scaleShowHorizontalLines:!0,scaleShowVerticalLines:!0,bezierCurve:!0,bezierCurveTension:.3,pointDot:!0,pointDotRadius:4,pointDotStrokeWidth:1,pointHitDetectionRadius:5,datasetStroke:!0,datasetStrokeWidth:2,datasetFill:!0,maintainAspectRatio:!1})}return $("#lineChartAlert").html("<code>"+e+"</code>&nbsp;&nbsp;har for f&aring; nylige lagringspunkter registrert til &aring; bygge grafen."),$("#lineChartAlert").show(),b="INGEN",!1}function l(){m!==!1&&(m.destroy(),m=!1)}function u(){var e=JSON.parse(JSON.stringify(RELAY.subscribersInfo())),t=$("#pageSuperAdmin").find("#subscribersTableSuperAdmin").DataTable({language:CONFIG.DATATABLES_LANGUAGE(),bAutoWidth:!0,sDom:'T<"clear">lfrtip',oTableTools:{sSwfPath:"dist/plugins/datatables/tabletools/swf/copy_csv_xls_pdf.swf",aButtons:[{sExtends:"copy",sButtonText:"Kopier"},{sExtends:"collection",sButtonText:"Lagre",aButtons:[{sExtends:"pdf",sPdfOrientation:"landscape",sTitle:"Relay_Abonnenter"},{sExtends:"xls",sButtonText:"Excel (.csv)",sTitle:"Relay_Abonnenter"}]}]},data:UTILS.convertDataTablesData(e),columns:[{data:"id",render:function(e,t,n,r){return"<button class='btn btn-link org' data-org='"+e+"'>"+e+"</button>"}},{data:"users",render:function(e,t,n,r){return n.users.total}},{data:"employees",render:function(e,t,n,r){return n.users.employees}},{data:"students",render:function(e,t,n,r){return n.users.students}},{data:"presentations",render:function(e,t,n,r){return n.presentations.total}},{data:"hits",render:function(e,t,n,r){return n.hits.hits}},{data:"storage",render:function(e,t,n,r){return UTILS.mib2gb(n.total_mib).toFixed(2)}},{data:"storage",render:function(e,t,n,r){return(UTILS.mib2tb(n.total_mib)*RELAY.storageCostTB()).toFixed()+"kr"}}]});return $("#pageSuperAdmin").find("#subscribersTableBox").find(".ajax").hide(),t}function g(e){var t=e,n=$("#emailExportSuperAdminModal");n.find("#emailExportTargetGroup").html(t.data("exportGroup")),n.find("#emailMissing").html(""),n.find("#emailExportCount").html(""),n.find("#emailExportList").html("Henter liste, vennligst vent....");var r=[];"brukere"===t.data("exportGroup")&&$.when(RELAY.orgUserListXHR(h)).then(function(e){$.each(e,function(e,t){r.push(t.userDisplayName+" <"+t.userEmail+">")}),n.find("#emailExportCount").html(r.length),n.find("#emailExportList").html(r.toString())})}function c(){var e=$("#pageSuperAdmin").find("#inputCostTB").val();RELAY.setStorageCost(e)&&(t(),p.destroy(),p=u())}var p,f=!1,m=!1,h="",b=0;return $(".refreshQueueFailedJobs").on("click",function(){i()}),$("#chartOrgsUserCountSuperAdmin").on("click",function(e){var n=f.getSegmentsAtEvent(e);o(n[0].label)&&(m=d(h,n[0]._saved.fillColor),t(),$("html, body").animate({scrollTop:$("#orgDetailsHeader").offset().top+"px"},"fast"))}),$("ul#orgListSuperAdmin").on("click","li.orgLineChartSelector",function(){o($(this).data("org"))&&(m=d(h),t())}),$("#subscribersTableSuperAdmin").on("click","button.org",function(){o($(this).data("org"))&&(m=d(h),t(),$("html, body").animate({scrollTop:$("#orgDetailsHeader").offset().top+"px"},"fast"))}),$("#orgUsageLineChartSuperAdmin").on("click",function(e){m.datasets[0].fillColor="#"+(Math.random().toString(16)+"0000000").slice(2,8),m.update()}),$(".email_export").on("click",function(){g($(this))}),$("#dataExportModal").on("show.bs.modal",function(e){if("superAdmin"===$(e.relatedTarget).data().context){var t=$(this),n=$(e.relatedTarget).data().action;switch(APP.jsonEditor().setName(n),APP.jsonEditor().set("Henter data, vennligst vent..."),n){case"Brukere":t.find(".modal-title").html('<i class="ion ion-ios-people"></i> Eksporter metadata for alle <strong>brukere</strong> ved <code>'+h+"</code>"),$.when(RELAY.orgUserListXHR(h)).then(function(e){APP.jsonEditor().set(e)});break;case"Opptak":t.find(".modal-title").html('<i class="ion ion-ios-film"></i> Eksporter metadata for alle <strong>opptak</strong> fra <code>'+h+"</code>"),$.when(RELAY.orgPresentationListXHR(h)).then(function(e){APP.jsonEditor().set(e)})}}}),$("#dataExportModal").on("hide.bs.modal",function(e){APP.jsonEditor().set("Henter data, vennligst vent...")}),$("#pageSuperAdmin #btnInvoiceCalc").on("click",c),{init:function(){return e()},hide:function(){r()},show:function(){n()}}}();