var PAGE_DASHBOARD=function(){function e(){r(),a(30),t()}function t(){$("#pageDashboard").find("[id^=relayQueueMonitor]").find(".ajax").show(),$(".queueTotal").html('<i class="fa fa-spinner fa-pulse"></i>'),$.when(RELAY.serviceQueueXHR()).done(function(e){var t=e.length;$("#pageDashboard").find("[id^=relayQueueMonitor]").find(".ajax").hide(),$(".queueTotal").html(t),c=e,n()})}function n(){var e=$("#queueTableBody");if(e.html(""),0==c.length)return void e.html('<tr><td colspan="2"><strong>Det er ingen jobber i kø akkurat nå</strong></td></tr>');var t,n=!1,a=0,r=!1;$.each(c,function(s,i){t=i.jobPresentation_PresId,n||(n=t),a>0&&t!=n&&(e.append("<tr><td>#"+r.jobPresentation_PresId+"</td><td>"+r.jobQueuedDate+", kl. "+r.jobQueuedTime+"</td><td>"+a+"</td><td>"+UTILS.secToTime(r.presDuration/1e3)+"</td><td>"+r.presPresenterName.substring(0,r.presPresenterName.indexOf(" "))+"</td></tr>"),a=0,n=i.jobPresentation_PresId),a++,r=i}),e.append("<tr><td>#"+r.jobPresentation_PresId+"</td><td>"+r.jobQueuedDate+", kl. "+r.jobQueuedTime+"</td><td>"+a+"</td><td>"+UTILS.secToTime(r.presDuration/1e3)+"</td><td>"+r.presPresenterName.substring(0,r.presPresenterName.indexOf(" "))+"</td></tr>")}function a(e){$.when(RELAY.hitsTotalXHR()).done(function(e){$(".hitsTotalGlobal").html(e.hits),$(".hitsFirstRecord").html(UTILS.timestamp2date(e.first_timestamp))}),$.when(RELAY.hitsByDaysXHR(e)).done(function(t){var n,a=[],r=0;return $.each(t,function(e,t){n=parseInt(new Date(t.log_date).getTime()),a.push({date:n,hits:t.hits}),r+=parseInt(t.hits)}),a.pop(),$(".hitsLastDaysTotal").html(r),$(".hitsLastDaysChartDays").html(e),$("#hitsLastDaysChartContainer").find(".ajax").hide(),new Morris.Line({element:"hitsLastDaysChart",resize:!0,data:a,xkey:"date",xLabelFormat:function(e){return("0"+e.getUTCDate()).slice(-2)+"."+("0"+(e.getUTCMonth()+1)).slice(-2)+"."+e.getUTCFullYear()},dateFormat:function(e){return e=new Date(e),("0"+e.getUTCDate()).slice(-2)+"."+("0"+(e.getUTCMonth()+1)).slice(-2)+"."+e.getUTCFullYear()},ykeys:["hits"],labels:["Visninger"],lineColors:["#3c8dbc"],hideHover:"auto"})})}function r(){$("#subscriber_table_body").empty();var e,t="---",n="red";$.each(KIND.subscribers(),function(a,r){e="",t=KIND.subscriptionCodesToNames()[r.subscription_code],n=KIND.subscriptionCodesToColors()[r.subscription_code],r.org_id==DATAPORTEN.user().org.id&&(e="active"),$("#subscriber_table_body").append("<tr class='"+e+"'><td>"+r.org_id+"</td><td style='text-align: center;'><span class='label bg-"+n+"'>"+t+"</span></td></tr>")}),$("#pageDashboard").find("#subscribersTable").find(".ajax").hide()}function s(e){d();var t=[];$.each(e,function(e,n){t.push({value:n.users,color:"#"+(Math.random().toString(16)+"0000000").slice(2,8),highlight:"#"+(Math.random().toString(16)+"0000000").slice(2,8),label:""})});var n=document.getElementById("chartOrgsUserCountDashboard").getContext("2d");return new Chart(n).Pie(UTILS.arrayShuffle(t),{})}function i(){$.when(RELAY.ready()).done(function(){u=s(RELAY.subscribersInfo()),$("#pageDashboard").find("#usersPie").find(".ajax").hide()}),RELAY_USER.hasAccount()||$("#relayAccountInfo").html("<p>"+DATAPORTEN.user().name.first+', du har ingen konto i tjenesten!</p><p><a href="'+CONFIG.RELAY_REGISTER_URL()+'" target="_blank" class="btn btn-info">Opprett konto</a></p>')}function o(){d()}function d(){u!==!1&&(u.destroy(),u=!1,$("#pageDashboard").find("#usersPie").find(".ajax").show())}var u=!1,c=[];return $(".updateQueue").on("click",function(){t()}),{init:function(){return e()},hide:function(){o()},show:function(){i()},refreshQueue:function(){t()}}}();